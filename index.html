<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Technician Dashboard</title>

  <!-- Include Bootstrap 5 for styling -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-KyZXEJv9nS3L34x7t6ZtIHhGbFd0ZWEzPQbPz0e/6nAAh2Z7e8C1jvpcG67wfsIm" crossorigin="anonymous">

  <style>
    /* Custom styles for dashboard */
    .card-deck {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      margin-top: 30px;
    }
    .card {
      flex: 0 0 23%;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>

  <!-- Navbar (Optional) -->
  <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">Technician Dashboard</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <a class="nav-link active" href="index.html">Dashboard</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="profile.html">Profile</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="jobs.html">Jobs</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" onclick="logout()">Logout</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container">
    <h3 class="mt-4">Dashboard</h3>

    <!-- Dashboard Stats -->
    <div class="card-deck">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Jobs Completed</h5>
          <p class="card-text display-4" id="jobsCompleted">Loading...</p>
        </div>
      </div>

      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Pending Jobs</h5>
          <p class="card-text display-4" id="pendingJobs">Loading...</p>
        </div>
      </div>

      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Technicians Online</h5>
          <p class="card-text display-4" id="techsOnline">Loading...</p>
        </div>
      </div>
    </div>

    <!-- Job Completion Chart -->
    <div class="mt-4">
      <h5>Job Completion Chart</h5>
      <canvas id="jobCompletionChart" width="400" height="200"></canvas>
    </div>

    <!-- Technician Performance Chart -->
    <div class="mt-4">
      <h5>Technician Performance</h5>
      <canvas id="technicianPerformanceChart" width="400" height="200"></canvas>
    </div>

    <!-- Real-Time Notifications -->
    <div class="mt-4">
      <h5>Notifications</h5>
      <ul id="notifications" class="list-group">
        <!-- Notifications will appear here -->
      </ul>
    </div>
  </div>

  <!-- Include Custom Script -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/socket.io-client@4.0.0/dist/socket.io.min.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", async function () {
      const token = localStorage.getItem("token");

      if (!token) {
        window.location.href = "login.html";
        return;
      }

      try {
        const response = await fetch('https://your-backend-url.onrender.com/api/dashboard', {
          headers: {
            'Authorization': `Bearer ${token}`,
          },
        });

        if (response.ok) {
          const data = await response.json();
          // Update dashboard with fetched data
          document.getElementById('jobsCompleted').textContent = data.jobsCompleted;
          document.getElementById('pendingJobs').textContent = data.pendingJobs;
          document.getElementById('techsOnline').textContent = data.techsOnline;

          // Initialize the job completion chart
          const jobCompletionChart = new Chart(document.getElementById("jobCompletionChart"), {
            type: "bar",
            data: {
              labels: ["Completed", "Pending"],
              datasets: [{
                label: "Jobs",
                data: [data.jobsCompleted, data.pendingJobs],
                backgroundColor: ["#36a2eb", "#ff6384"],
              }],
            },
          });

          // Initialize technician performance chart
          const technicianPerformanceChart = new Chart(document.getElementById("technicianPerformanceChart"), {
            type: "pie",
            data: {
              labels: data.technicianNames,
              datasets: [{
                label: "Performance",
                data: data.technicianPerformance,
                backgroundColor: ["#ffcd56", "#4bc0c0"],
              }],
            },
          });

        } else {
          const error = await response.json();
          alert(error.message);
        }
      } catch (error) {
        console.error('Error:', error);
        alert('An error occurred. Please try again.');
      }

      // Real-time Notifications with Socket.IO
      const socket = io();
      const notificationsList = document.getElementById("notifications");

      socket.on("notification", (message) => {
        const notificationItem = document.createElement("li");
        notificationItem.className = "list-group-item";
        notificationItem.textContent = message;
        notificationsList.appendChild(notificationItem);
      });

      // Example: Send a notification
      socket.emit("notification", "Technician John Doe has started a job.");
    });

    function logout() {
      localStorage.removeItem('token');
      window.location.href = 'login.html';
    }
  </script>

  <!-- Include Bootstrap 5 JS (Optional, for Modal/Dropdown functionality) -->
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.10.2/dist/umd/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.min.js"></script>

</body>
</html>
